# SQL-Replay
A tool for replaying events captured through SQL Server Extended Events

## Overview
The SQL Repay tool was created since SQL Server's Replay feature is based on SQL Server Profiler traces rather than SQL Server Extended Events.

Other key features of the SQL Replay tool:
- We don't want to replay events in a serial, synchronous manner. We want to simulate events firing concurrently at the same points in time as they took place in the event capture.
- We want to support bulk inserts. SQL Server Extended Events do not include the actual data bulk inserted, so the SQL Replay tool creates fake data based on column definitions to allow for simulating bulk inserts.
- We want to replay stored procedure calls as remote procedure calls (RPC) rather than just replay the captured SQL statement representing the call as a SQL batch, which is important for preventing additional compilations and significantly inflating the number of compilations/sec.

## Usage

### Prepping for Tests

The SQL Replay tool executes binary data derived from Extended Events captures. The process of creating this binary data from an Extended Events capture is referred to as "prepping".

In order to prep Extended Events capture files, simply execute the SQL Replay tool from the command-line using the prep parameter.

```
SqlReplay.Console.exe prep "C:\capture\" "C:\capture\output\" 10 "Server=MYSERVER;Database=MYDATABASE;User Id=user;Password=password;Max Pool Size=1000;Connection Timeout=60;" "12/9/2019 3:30:00 PM +00:00"
```

The first folder path is the location of the Extended Events capture files you wish to process. 

The second folder path is the location in which you want to output the binary data derived from those Extended Events capture files. 

The 10 in this example is the number of binary data files you want to split the binary data into. Splitting the binary data into multiple files is key for distributing the calls across multiple processes to handle more traffic.

Next is a connection string to a database that matches the one you plan to test against in terms of code signatures. This connection string is used for two purposes:
1. Rather than just execute the same ad hoc SQL used to execute stored procedures captured through Extended Events, the SQL Replay tool uses stored procedure information from the database to build ADO.NET commands. This is important because the ad hoc SQL used to execute stored procedures artificially drives up compilations/sec.
2. The connection string is embedded in the binary data and used when executing the replay tests--unless you override that by passing a new connection string when executing the tests. For more details on the properties used in the connection string in the example, please see the next section on running tests.

The final parameter in the example is an optional cutoff date/time. This can be used if you wish to exclude some portion of the Extended Events catpure from your binary data in order to create a shorter test.

### Running Tests

In order to actually run a test, simply execute the SQL Replay tool from the command-line using the run parameter.

```
SqlReplay.Console.exe run "C:\capture\output\replay0.txt" "Server=MYSERVER;Database=MYDATABASE;User Id=user;Password=password;Max Pool Size=1000;Connection Timeout=60;"
```

The file path is the path to a binary data file generated by the prepping process.

Next is a connection string which can be used to override the connection string embedded in the binary data file in case you want to test against a different SQL Server instance than the one used to prep the binary data file. You'll notice that the example connection string sets max pool size to 1000 and connection timeout to 60. Max pool size is important for ensuring each process can open a sufficient number of connections to SQL Server at a time without overloading it. Connection timeout is important for ensuring that more time is given when trying to establish a connection to SQL Server than the default 15 seconds, which can be important to establishing SQL connections successfully under heavy load.

Exceptions encountered during the execution of a replay test are held in memory and then dumped out into a log file corresponding to the binary data file being run after all tests in that binary data file have been completed.
